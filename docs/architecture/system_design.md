# Core Components

## UI Manager

### Responsibilities

- Accepts user input.
- Displays the code execution stream.
- Displays Gemini's response stream.

### Notes

- Must maintain consistent styling.

### Function Signatures

- ```python
    def render_markdow(chunk: str | ExitCode) -> None
  ```
- ```python
    def render_cmd_output(chunk: str | ExitCode) -> None # Must implement max display limit
  ```
- ```python
    def take_user_input() -> str # Input must be trimmed
  ```

## Input Router

### Responsibilities

- Parses user input to determine whether it is a prompt (to be forwarded to the Prompt Engine) or a direct command (to be forwarded to the Execution Engine).

### Core Algorithms for Prediction

1. **Prefix Detection Algorithm**

   - Checks for shell prefixes (`!`, `$`, `>`).
   - Adds `+0.8` to `command_confidence` for exact matches, `+0.1` to `prompt_confidence` otherwise.

2. **Command Dictionary Matching**

   - Splits input and checks the first word against known commands (`ls`, `cd`, `pwd`, `git`, `python`, `npm`, `curl`, `grep`).
   - Adds `+0.7` to `command_confidence` for matches, `+0.2` to `prompt_confidence` for non-matches.

3. **Question Pattern Detection**

   - Scans for question words (`what`, `how`, `why`, `help`), question marks, and conversational patterns.
   - Adds `+0.6` to `prompt_confidence` for matches, `+0.1` to `command_confidence` otherwise.

4. **Sentence Structure Analysis**
   - Checks for complete sentences with proper grammar, articles (`a`, `an`, `the`), and punctuation. Commands typically lack these patterns.
   - Adds `+0.5` to `prompt_confidence` for sentence-like structure, `+0.3` to `command_confidence` for command-like syntax.

### Function Signatures

- ```python
    def route_input(user_input: str) -> RouteDecision
  ```

- ```python
    class RouteDecision(BaseModel):
            prediction: Literal["command", "prompt"]
  ```

## Execution Engine

### Responsibilities

- Executes shell commands directly.

### Notes

- Returns output as a stream.

### Function Signatures

- ```python
    def execute_command(command: str) -> Iterator[str | ExitCode]
    # Yields output character by character.
    # Handles errors, timeouts, and sudo prompts.
  ```
- ```python
    class ExitCode(BaseModel):
      exit_code: Literal[0, 1]
  ```

## Prompt Engine

### Responsibilities

- Formats prompts with system instructions and session memory.

### Function Signatures

- ```python
    def format_prompt(system_instructions: str, session_memory: str, new_prompt: str) -> str
  ```

## Session Memory

### Responsibilities

- Tracks input and output from direct user interactions with the Execution Engine.
- Tracks input and output from user and Execution Engine interactions with the LLM model.

### Notes

- Must adhere to the data structure specified in Gemini's documentation.
- Should implement a maximum threshold to discard very old session data.

### Function Signatures

- ```python
  def add_entry(role: Literal["user", "llm", "system"], content: str) -> None
  # Automatically checks threshold and removes oldest entries if limit exceeded
  ```
- ```python
  def format_to_string() -> str
  # Converts entire session history into formatted string for prompt engine
  ```

## History Filter

### Responsibilities

- Determines whether direct interactions between the user and the Execution Engine should be stored in session memory.
- Makes entery in session memory on accepting an interaction.

### Core Algorithms

1. **Command Blacklist Filter**

- Immediately rejects common, low-value commands (`ls`, `pwd`, `clear`).
- If a command is on the blacklist, it is never stored.

2. **Error Preservation**

- Checks the `ExecutionStatus` of a command.
- If the command resulted in an error (non-zero exit code), it bypasses all other filters and is marked for storage.

1. **Sensitive Data Filter**

- Applied only to interactions that are marked for storage.
- Uses regex patterns to find and censor potential secrets, API keys, and passwords in the command output.

### Function Signatures

- ```python
    def filter_and_store_entry(
      command: str,
      output: str,
      status: ExitCode,
  ) -> None:
  ```

## Output Processor

### Responsibilities

- Parses the output generated by the Execution Engine before passing it to the LLM.

### Thresholds

1. Maximum Output Size: 8,000 characters - triggers intelligent truncation
2. Intelligent Truncation: Keep first 2,000 chars + last 4,000 chars, compress middle
3. Error Preservation: Always preserve error messages regardless of size

### Function Signatures

- ```python
  def process_output(output: str, exit_code: ExitCode) -> str
  # Processes streamed output, applies size limits, preserves errors
  # Returns formatted string ready for LLM consumption
  ```

## LLM Orchestrator

### Responsibilities

- Manages all API calls to the LLM, including prompt submission and response retrieval.
- Handles function calling by interpreting function requests from the LLM and invoking the appropriate system functions.
- Ensures error handling and retries for failed API calls.
- Maintains authentication and rate limiting for LLM API usage.

## Interruption Handling

### Ctrl+C Scenarios Analysis

| Scenario                                | What Happens                                 | Handling                                                     | Who Handles                                 |
| --------------------------------------- | -------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------- |
| App Waiting for User Input (UI Manager) | User typing, hits Ctrl+C                     | Prompt: "Are you sure you want to exit? (y/n)" then exit app | UI Manager (custom code)                    |
| Command Executing (Execution Engine)    | Command (e.g., `sleep 1000`) running, Ctrl+C | Kill subprocess, return to prompt                            | Execution Engine (`subprocess.terminate()`) |
| LLM API Call (Prompt Engine)            | Waiting for LLM response, Ctrl+C             | Cancel API request, return to prompt                         | Prompt Engine (request cancellation)        |
| Processing Between Components           | Internal logic running, Ctrl+C               | Python raises `KeyboardInterrupt`, app exits (unless caught) | Python (should catch and handle gracefully) |
| UI Rendering (UI Manager)               | Rendering output, Ctrl+C                     | Stop rendering, return to prompt                             | Textual framework + custom code             |
